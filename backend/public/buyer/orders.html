<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è¨‚å–®è¿½è¹¤ | ReuseX</title>
  <link rel="stylesheet" href="style.css">
</head>

<body>

  <!-- ===== å°è¦½åˆ— ===== -->
  <div class="navbar">
    <div class="nav-left">
      <img src="images/logo.png" class="logo-img">
      <a href="buyer.html">é¦–é </a>
      <a href="buyer.html">è²·å®¶åŠŸèƒ½</a>
      <a href="orders.html"><strong>è¨‚å–®è¿½è¹¤</strong></a>
      <a href="myreviews.html">æˆ‘çš„è©•åƒ¹</a>
    </div>
  </div>

  <div class="product-list">

    <h2>ğŸ“¦ æˆ‘çš„è¨‚å–®</h2>

    <!-- ===== ç¯©é¸å€ ===== -->
    <div class="filter-area">
      <label>ç¯©é¸è¨‚å–®ï¼š</label>
      <select id="orderFilter">
        <option value="all">å…¨éƒ¨è¨‚å–®</option>
        <option value="reviewed">å·²è©•åƒ¹</option>
        <option value="unreviewed">æœªè©•åƒ¹</option>
      </select>
    </div>

    <div id="orderContainer"></div>
  </div>

  <!-- ===== èŠå¤©è¦–çª— ===== -->
  <div id="chatModal" class="modal hidden">
    <div class="chat-box">
      <h3 id="chatTitle">èˆ‡è³£å®¶èŠå¤©</h3>

      <div id="chatMessages" class="chat-messages"></div>

      <div class="chat-input-area">
        <input type="text" id="chatInput" placeholder="è¼¸å…¥è¨Šæ¯..." />
        <button id="sendChatBtn" class="save-btn">é€å‡º</button>
      </div>

      <button id="closeChat" class="save-btn close-chat">é—œé–‰</button>
    </div>
  </div>


<!-- ===== SCRIPT START ===== -->
<script>
  const orders = JSON.parse(localStorage.getItem("orders")) || [];
  const reviews = JSON.parse(localStorage.getItem("reviews")) || [];
  let chats = JSON.parse(localStorage.getItem("chats")) || {};

  const container = document.getElementById("orderContainer");
  const filterSelect = document.getElementById("orderFilter");

  // ===== æ¸²æŸ“è¨‚å–® =====
  function renderOrders(filter = "all") {
    container.innerHTML = "";

    if (orders.length === 0) {
      container.innerHTML = "<p>ç›®å‰æ²’æœ‰è¨‚å–®ã€‚</p>";
      return;
    }

    // æ–° â†’ èˆŠ
    const sorted = [...orders].sort((a, b) => b.id - a.id);

    const filtered = sorted.filter(order => {
      const reviewed = reviews.some(r => r.orderId === order.id);
      if (filter === "all") return true;
      if (filter === "reviewed") return reviewed;
      if (filter === "unreviewed") return !reviewed;
    });

    if (filtered.length === 0) {
      container.innerHTML = "<p>æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„è¨‚å–®ã€‚</p>";
      return;
    }

    filtered.forEach(order => {
      const reviewed = reviews.some(r => r.orderId === order.id);

      // â˜… ä¿®æ­£ï¼šå–å•†å“åç¨±
      const productNames = order.items.map(i => i.name).join("ã€");

      const div = document.createElement("div");
      div.classList.add("product-card");

      div.innerHTML = `
        <h3>è¨‚å–®ç·¨è™Ÿï¼š${order.id}</h3>
        <p>ä¸‹å–®æ™‚é–“ï¼š${order.date}</p>
        <p>ç‹€æ…‹ï¼š<strong>${order.status}</strong></p>
        <p class="items">å•†å“å…§å®¹ï¼š${productNames}</p>

        <button class="save-btn review-btn"
                data-id="${order.id}"
                ${reviewed ? "disabled" : ""}>
          ${reviewed ? "å·²è©•åƒ¹" : "å»è©•åƒ¹"}
        </button>

        <button class="save-btn contact-btn" 
                data-id="${order.id}"
                data-items="${productNames}">
          è¯çµ¡è³£å®¶
        </button>
      `;

      container.appendChild(div);
    });
  }

  // åˆæ¬¡æ¸²æŸ“
  renderOrders();

  // ===== ç¯©é¸äº‹ä»¶ =====
  filterSelect.addEventListener("change", () => {
    renderOrders(filterSelect.value);
  });


  // =======================
  // ===== èŠå¤©åŠŸèƒ½ =======
  // =======================

  const chatModal = document.getElementById("chatModal");
  const chatMessages = document.getElementById("chatMessages");
  const chatInput = document.getElementById("chatInput");
  const sendChatBtn = document.getElementById("sendChatBtn");
  const closeChat = document.getElementById("closeChat");

  let currentChatOrderId = null;

  // æ‰“é–‹èŠå¤©
  function openChat(orderId, productNames) {
    currentChatOrderId = orderId;

    document.getElementById("chatTitle").textContent =
      "è¨‚å–® " + orderId + "ï½œå•†å“ï¼š" + productNames;

    chatModal.classList.remove("hidden");
    loadChatMessages();
  }

  // é¡¯ç¤ºèŠå¤©ç´€éŒ„
  function loadChatMessages() {
    chatMessages.innerHTML = "";

    const msgs = chats[currentChatOrderId] || [];

    msgs.forEach(m => {
      const div = document.createElement("div");
      div.classList.add("chat-message");
      div.classList.add(m.from === "buyer" ? "chat-buyer" : "chat-seller");
      div.textContent = m.text;
      chatMessages.appendChild(div);
    });

    chatMessages.scrollTop = chatMessages.scrollHeight;
  }

  // ç™¼é€èŠå¤©è¨Šæ¯
  sendChatBtn.onclick = () => {
    const text = chatInput.value.trim();
    if (!text) return;

    if (!chats[currentChatOrderId]) chats[currentChatOrderId] = [];

    chats[currentChatOrderId].push({
      from: "buyer",
      text,
      time: new Date().toLocaleTimeString()
    });

    localStorage.setItem("chats", JSON.stringify(chats));
    chatInput.value = "";
    loadChatMessages();
  };

  // é—œé–‰èŠå¤©
  closeChat.onclick = () => chatModal.classList.add("hidden");

  // é»æ“Šè¯çµ¡è³£å®¶
  document.addEventListener("click", (e) => {
    if (e.target.classList.contains("contact-btn")) {
      const orderId = e.target.dataset.id;
      const productNames = e.target.dataset.items;
      openChat(orderId, productNames);
    }
  });
// é»æ“Šã€Œå»è©•åƒ¹ã€
document.addEventListener("click", (e) => {
  if (e.target.classList.contains("review-btn")) {
    const orderId = e.target.dataset.id;
    if (!e.target.disabled) {
      window.location.href = `rate.html?orderId=${orderId}`;
    }
  }
});

</script>
<!-- ===== SCRIPT END ===== -->

</body>
</html>
