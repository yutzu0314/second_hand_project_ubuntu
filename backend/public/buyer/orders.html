<!DOCTYPE html>
<html lang="zh-Hant">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è¨‚å–®è¿½è¹¤ | ReuseX</title>
  <link rel="stylesheet" href="style.css">
</head>

<body>

  <!-- ===== å°è¦½åˆ— ===== -->
  <div class="navbar">
    <div class="nav-left">
      <img src="images/logo.png" class="logo-img">
      <a href="buyer.html">é¦–é </a>
      <a href="buyer.html">è²·å®¶åŠŸèƒ½</a>
      <a href="orders.html"><strong>è¨‚å–®è¿½è¹¤</strong></a>
      <a href="myreviews.html">æˆ‘çš„è©•åƒ¹</a>
    </div>
  </div>

  <div class="product-list">

    <h2>ğŸ“¦ æˆ‘çš„è¨‚å–®</h2>

    <!-- ===== ç¯©é¸å€ ===== -->
    <div class="filter-area">
      <label>ç¯©é¸è¨‚å–®ï¼š</label>
      <select id="orderFilter">
        <option value="all">å…¨éƒ¨è¨‚å–®</option>
        <option value="reviewed">å·²è©•åƒ¹</option>
        <option value="unreviewed">æœªè©•åƒ¹</option>
      </select>
    </div>

    <div id="orderContainer"></div>
  </div>

  <!-- ===== èŠå¤©è¦–çª— ===== -->
  <div id="chatModal" class="modal hidden">
    <div class="chat-box">
      <h3 id="chatTitle">èˆ‡è³£å®¶èŠå¤©</h3>

      <div id="chatMessages" class="chat-messages"></div>

      <div class="chat-input-area">
        <input type="text" id="chatInput" placeholder="è¼¸å…¥è¨Šæ¯..." />
        <button id="sendChatBtn" class="save-btn">é€å‡º</button>
      </div>

      <button id="closeChat" class="save-btn close-chat">é—œé–‰</button>
    </div>
  </div>


  <!-- ===== SCRIPT START ===== -->
  <script>
    // ==== è®€å–ç™»å…¥ä¸­çš„è²·å®¶ ====

    function loadCurrentUser() {
      try {
        const raw = localStorage.getItem("auth");
        if (raw && raw !== "null" && raw !== "undefined") {
          const parsed = JSON.parse(raw);
          if (parsed && parsed.id && parsed.role === "buyer") {
            return parsed;
          }
        }
      } catch (e) {
        console.error("parse auth failed", e);
      }

      const idStr = localStorage.getItem("user_id");
      const role = localStorage.getItem("role");
      const email = localStorage.getItem("email") || null;
      if (idStr && role === "buyer") {
        return {
          id: Number(idStr),
          email,
          role,
          token: localStorage.getItem("token") || null,
        };
      }
      return null;
    }

    const currentUser = loadCurrentUser();

    let orders = []; // å¾å¾Œç«¯æŠ“
    const reviews = JSON.parse(localStorage.getItem("reviews")) || [];
    
    const container = document.getElementById("orderContainer");
    const filterSelect = document.getElementById("orderFilter");

    // ==== å¾å¾Œç«¯æŠ“é€™å€‹è²·å®¶çš„è¨‚å–® ====
    const API_BASE = ""; // ä½ å¾Œç«¯å°±åœ¨ localhost:3000ï¼Œç•™ç©ºå³å¯

    async function fetchBuyerOrders() {
      if (!currentUser) {
        container.innerHTML = "<p>è«‹å…ˆç™»å…¥è²·å®¶å¸³è™Ÿå†æŸ¥çœ‹è¨‚å–®ã€‚</p>";
        return;
      }

      try {
        const params = new URLSearchParams({ buyer_id: currentUser.id });
        const res = await fetch(`${API_BASE}/api/order/list?${params.toString()}`);

        if (!res.ok) {
          const err = await res.json().catch(() => ({}));
          throw new Error(err.error || `è¼‰å…¥è¨‚å–®å¤±æ•— (${res.status})`);
        }

        const data = await res.json(); // { total, items }
        orders = data.items || [];
        renderOrders(filterSelect.value || "all");
      } catch (err) {
        console.error(err);
        container.innerHTML = "<p>è¼‰å…¥è¨‚å–®æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚</p>";
      }
    }

        


    // ===== æ¸²æŸ“è¨‚å–® =====
    function renderOrders(filter = "all") {
      container.innerHTML = "";

      if (!orders.length) {
        container.innerHTML = "<p>ç›®å‰æ²’æœ‰è¨‚å–®ã€‚</p>";
        return;
      }

      const sorted = [...orders].sort((a, b) => b.order_id - a.order_id);

      const filtered = sorted.filter((order) => {
        const reviewed = reviews.some(r => r.orderId === order.order_id);
        if (filter === "all") return true;
        if (filter === "reviewed") return reviewed;
        if (filter === "unreviewed") return !reviewed;
        return true;
      });

      if (!filtered.length) {
        container.innerHTML = "<p>æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„è¨‚å–®ã€‚</p>";
        return;
      }

      filtered.forEach(order => {
        const reviewed = reviews.some(r => r.orderId === order.order_id);

        const isCancelled = order.status === "cancelled";
        const canReview = (order.status === "completed") && !reviewed;
        const canChat = !isCancelled;

        const div = document.createElement("div");
        div.classList.add("product-card");
        if (isCancelled) div.classList.add("is-disabled");

        div.innerHTML = `
          <h3>è¨‚å–®ç·¨è™Ÿï¼š${order.order_id}</h3>
          <p>ä¸‹å–®æ™‚é–“ï¼š${new Date(order.created_at).toLocaleString()}</p>
          <p>ç‹€æ…‹ï¼š<strong>${order.status}</strong></p>
          <p class="items">å•†å“ï¼š${order.product_title}ï¼ˆNT$${order.product_price}ï¼‰</p>

          <button class="save-btn review-btn"
                  data-id="${order.order_id}"
                  ${canReview ? "" : "disabled"}>
            ${reviewed ? "å·²è©•åƒ¹" : (order.status !== "completed" ? "å®Œæˆå¾Œæ‰èƒ½è©•åƒ¹" : "å»è©•åƒ¹")}
          </button>

          <button class="save-btn contact-btn"
                  data-id="${order.order_id}"
                  data-items="${order.product_title}"
                  ${canChat ? "" : "disabled"}>
            è¯çµ¡è³£å®¶
          </button>
        `;

        container.appendChild(div);
      });
    }

    // =======================
    // ===== èŠå¤©åŠŸèƒ½ =======
    // =======================

    const chatModal = document.getElementById("chatModal");
    const chatMessages = document.getElementById("chatMessages");
    const chatInput = document.getElementById("chatInput");
    const sendChatBtn = document.getElementById("sendChatBtn");
    const closeChat = document.getElementById("closeChat");

    let currentChatOrderId = null;

    // æ‰“é–‹èŠå¤©
    function openChat(orderId, productNames) {
      currentChatOrderId = orderId;

      document.getElementById("chatTitle").textContent =
        "è¨‚å–® " + orderId + "ï½œå•†å“ï¼š" + productNames;

      chatModal.classList.remove("hidden");
      loadChatMessages();
      startChatPolling();
    }

    // é¡¯ç¤ºèŠå¤©ç´€éŒ„
    async function loadChatMessages() {
      chatMessages.innerHTML = "";

      try {
        const qs = new URLSearchParams({
          order_id: currentChatOrderId,
          user_id: currentUser.id
        });

        const res = await fetch(`/api/messages/list?${qs.toString()}`);
        const data = await res.json();

        if (!res.ok) throw new Error(data.error || "load messages failed");

        (data.items || []).forEach(m => {
          const div = document.createElement("div");
          div.classList.add("chat-message");
          div.classList.add(m.sender_id === currentUser.id ? "chat-me" : "chat-other");

          div.textContent = m.content;
          chatMessages.appendChild(div);
        });

        chatMessages.scrollTop = chatMessages.scrollHeight;
      } catch (e) {
        console.error(e);
        chatMessages.innerHTML = `<div style="padding:8px;">è¼‰å…¥è¨Šæ¯å¤±æ•—</div>`;
      }
    }


    // ç™¼é€èŠå¤©è¨Šæ¯
    sendChatBtn.onclick = async () => {
      const text = chatInput.value.trim();
      if (!text) return;

      try {
        const res = await fetch(`/api/messages/send`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            order_id: Number(currentChatOrderId),
            sender_id: Number(currentUser.id),
            content: text
          })
        });

        const data = await res.json().catch(() => ({}));
        if (!res.ok) {
          alert(data.error || `é€å‡ºå¤±æ•— (${res.status})`);
          return;
        }

        chatInput.value = "";
        await loadChatMessages();
      } catch (e) {
        console.error(e);
        alert("é€å‡ºè¨Šæ¯æ™‚ç™¼ç”ŸéŒ¯èª¤");
      }
    };

    //è¼ªè©¢
    let chatPollTimer = null;

    function startChatPolling() {
      stopChatPolling();
      chatPollTimer = setInterval(() => {
        if (currentChatOrderId) loadChatMessages();
      }, 2000);
    }

    function stopChatPolling() {
      if (chatPollTimer) clearInterval(chatPollTimer);
      chatPollTimer = null;
    }


    // é—œé–‰èŠå¤©
    closeChat.onclick = () => {
      chatModal.classList.add("hidden");
      stopChatPolling();
      currentChatOrderId = null;
    }
    // é»æ“Šè¯çµ¡è³£å®¶
    document.addEventListener("click", (e) => {
      const contactBtn = e.target.closest("button.contact-btn");
      if (contactBtn) {
        if (contactBtn.disabled) return; // âœ… æ“‹æ‰ disabled
        const orderId = contactBtn.dataset.id;
        const productNames = contactBtn.dataset.items || "";
        openChat(orderId, productNames);
        return;
      }

      const reviewBtn = e.target.closest("button.review-btn");
      if (reviewBtn) {
        if (reviewBtn.disabled) return; // âœ… æ“‹æ‰ disabled
        const orderId = reviewBtn.dataset.id;
        window.location.href = `rate.html?orderId=${orderId}`;
      }
    });


    // åˆæ¬¡è¼‰å…¥æ™‚ï¼Œå…ˆæ‰“ API æŠ“è¨‚å–®
    fetchBuyerOrders();

    // ç¯©é¸äº‹ä»¶ä¿æŒä¸è®Š
    filterSelect.addEventListener("change", () => {
      renderOrders(filterSelect.value);
    });


  </script>
  <!-- ===== SCRIPT END ===== -->

</body>

</html>